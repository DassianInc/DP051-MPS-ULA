<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Gnt-widget-calendar-Calendar'>/**
</span>
@class Gnt.widget.calendar.Calendar
@extends Ext.form.Panel
@aside guide gantt_calendars

{@img gantt/images/calendar.png}

This widget can be used to edit the calendar content. As the input it should receive an instance of the {@link Gnt.data.Calendar} class.
Once the editing is done and user is happy with the result the {@link #applyChanges} method should be called. It will apply
all the changes user made in UI to the calendar.

Note, this widget does not have the &quot;Ok&quot;, &quot;Apply changes&quot; etc button intentionally, as you might want to combine it with your widgets.
See {@link Gnt.widget.calendar.CalendarWindow} for this widget embedded in the Ext.window.Window instance.


*/
Ext.define('Gnt.widget.calendar.Calendar', {
    extend                      : 'Ext.form.Panel',

    requires                    : [
        'Ext.XTemplate',
        'Ext.data.Store',
        'Ext.grid.Panel',
        'Ext.grid.plugin.CellEditing',
        'Ext.layout.container.HBox',
        'Ext.layout.container.Column',
        'Ext.layout.container.Fit',
        'Gnt.data.Calendar',
        'Gnt.model.Week',
        'Gnt.widget.calendar.DayEditor',
        'Gnt.widget.calendar.WeekEditor',
        'Gnt.widget.calendar.DatePicker',
        'Gnt.patches.ComboBox'
    ],

    mixins                      : ['Gnt.mixin.Localizable'],

    alias                       : 'widget.calendar',

<span id='Gnt-widget-calendar-Calendar-property-defaults'>    defaults                    : { padding: 10, border: false },
</span>
<span id='Gnt-widget-calendar-Calendar-cfg-workingDayCls'>    /**
</span>     * @cfg {String} workingDayCls class will be applied to all working days at legend block and datepicker
     */
    workingDayCls               : 'gnt-datepicker-workingday',

<span id='Gnt-widget-calendar-Calendar-cfg-nonWorkingDayCls'>    /**
</span>     * @cfg {string} nonWorkingDayCls class will be applied to all non-working days at legend block and datepicker
     */
    nonWorkingDayCls            : 'gnt-datepicker-nonworkingday',

<span id='Gnt-widget-calendar-Calendar-cfg-overriddenDayCls'>    /**
</span>     * @cfg {String} overriddenDayCls class will be applied to all overridden days at legend block and datepicker
     */
    overriddenDayCls            : 'gnt-datepicker-overriddenday',

<span id='Gnt-widget-calendar-Calendar-cfg-overriddenWeekDayCls'>    /**
</span>     * @cfg {String} overriddenWeekDayCls class will be applied to all overridden days inside overridden week at legend block and date picker
     */
    overriddenWeekDayCls        : 'gnt-datepicker-overriddenweekday',

<span id='Gnt-widget-calendar-Calendar-cfg-calendar'>    /**
</span>     * @cfg {Gnt.data.Calendar} calendar An instance of the {@link Gnt.data.Calendar} to read/change the holidays from/in.
     */
    calendar                    : null,

<span id='Gnt-widget-calendar-Calendar-property-calendarManager'>    calendarManager             : null,
</span>
<span id='Gnt-widget-calendar-Calendar-cfg-l10n'>    /**
</span>     * @cfg {Object} l10n
     * A object, purposed for the class localization. Contains the following keys/values:

        - dayOverrideNameHeaderText : 'Name',
        - overrideName        : 'Name',
        - startDate           : 'Start Date',
        - endDate             : 'End Date',
        - error               : 'Error',
        - dateText            : 'Date',
        - addText             : 'Add',
        - editText            : 'Edit',
        - removeText          : 'Remove',
        - workingDayText      : 'Working day',
        - weekendsText        : 'Weekends',
        - overriddenDayText   : 'Overridden day',
        - overriddenWeekText  : 'Overridden week',
        - workingTimeText     : 'Working time',
        - nonworkingTimeText  : 'Non-working time',
        - dayOverridesText    : 'Day overrides',
        - weekOverridesText   : 'Week overrides',
        - okText              : 'OK',
        - cancelText          : 'Cancel',
        - parentCalendarText  : 'Parent calendar',
        - noParentText        : 'No parent',
        - selectParentText    : 'Select parent',
        - newDayName          : '[Without name]',
        - calendarNameText    : 'Calendar name',
        - tplTexts            : {
            - tplWorkingHours : 'Working hours for',
            - tplIsNonWorking : 'is non-working',
            - tplOverride     : 'override',
            - tplInCalendar   : 'in calendar',
            - tplDayInCalendar: 'standard day in calendar'
        },
        - overrideErrorText   : 'There is already an override for this day',
        - overrideDateError   : 'There is already week override on this date: {0}',
        - startAfterEndError  : 'Start date should be less than end date',
        - weeksIntersectError : 'Week overrides should not intersect'
     */

<span id='Gnt-widget-calendar-Calendar-cfg-dayGridConfig'>    /**
</span>     * @cfg {Object} dayGridConfig A custom config object to use when configuring the Gnt.widget.calendar.DayGrid instance.
     */
    dayGridConfig               : null,

<span id='Gnt-widget-calendar-Calendar-cfg-weekGridConfig'>    /**
</span>     * @cfg {Object} weekGridConfig A custom config object to use when configuring the Gnt.widget.calendar.WeekGrid instance.
     */
    weekGridConfig              : null,

<span id='Gnt-widget-calendar-Calendar-cfg-datePickerConfig'>    /**
</span>     * @cfg {Object} datePickerConfig A custom config object to use when configuring the Gnt.widget.calendar.DatePicker instance.
     */
    datePickerConfig            : null,

<span id='Gnt-widget-calendar-Calendar-property-dayGrid'>    dayGrid                     : null,
</span><span id='Gnt-widget-calendar-Calendar-property-weekGrid'>    weekGrid                    : null,
</span><span id='Gnt-widget-calendar-Calendar-property-datePicker'>    datePicker                  : null,
</span>
<span id='Gnt-widget-calendar-Calendar-property-legendTpl'>    legendTpl                   : '&lt;ul class=&quot;gnt-calendar-legend&quot;&gt;' +
</span>            '&lt;li class=&quot;gnt-calendar-legend-item&quot;&gt;' +
                '&lt;div class=&quot;gnt-calendar-legend-itemstyle {workingDayCls}&quot;&gt;&lt;/div&gt;' +
                '&lt;span class=&quot;gnt-calendar-legend-itemname&quot;&gt;{workingDayText}&lt;/span&gt;' +
                '&lt;div style=&quot;clear: both&quot;&gt;&lt;/div&gt;' +
            '&lt;/li&gt;' +
            '&lt;li&gt;' +
                '&lt;div class=&quot;gnt-calendar-legend-itemstyle {nonWorkingDayCls}&quot;&gt;&lt;/div&gt;' +
                '&lt;span class=&quot;gnt-calendar-legend-itemname&quot;&gt;{weekendsText}&lt;/span&gt;' +
                '&lt;div style=&quot;clear: both&quot;&gt;&lt;/div&gt;' +
            '&lt;/li&gt;' +
            '&lt;li class=&quot;gnt-calendar-legend-override&quot;&gt;' +
                '&lt;div class=&quot;gnt-calendar-legend-itemstyle {overriddenDayCls}&quot;&gt;31&lt;/div&gt;' +
                '&lt;span class=&quot;gnt-calendar-legend-itemname&quot;&gt;{overriddenDayText}&lt;/span&gt;' +
                '&lt;div style=&quot;clear: both&quot;&gt;&lt;/div&gt;' +
            '&lt;/li&gt;' +
            '&lt;li class=&quot;gnt-calendar-legend-override&quot;&gt;' +
                '&lt;div class=&quot;gnt-calendar-legend-itemstyle {overriddenWeekDayCls}&quot;&gt;31&lt;/div&gt;' +
                '&lt;span class=&quot;gnt-calendar-legend-itemname&quot;&gt;{overriddenWeekText}&lt;/span&gt;' +
                '&lt;div style=&quot;clear: both&quot;&gt;&lt;/div&gt;' +
            '&lt;/li&gt;' +
        '&lt;/ul&gt;',

<span id='Gnt-widget-calendar-Calendar-property-dateInfoTpl'>    dateInfoTpl                 : null,
</span>
<span id='Gnt-widget-calendar-Calendar-property-dayOverridesCalendar'>    dayOverridesCalendar        : null,
</span><span id='Gnt-widget-calendar-Calendar-property-weekOverridesStore'>    weekOverridesStore          : null,
</span>
<span id='Gnt-widget-calendar-Calendar-property-copiesIndexByOriginalId'>    copiesIndexByOriginalId     : null,
</span>
<span id='Gnt-widget-calendar-Calendar-property-currentDayOverrideEditor'>    // reference to a window with day override editor used only in tests for now
</span>    currentDayOverrideEditor    : null,

<span id='Gnt-widget-calendar-Calendar-property-calendarDayModel'>    calendarDayModel            : null,
</span>
<span id='Gnt-widget-calendar-Calendar-property-layout'>    layout                      : {
</span>        type    : 'vbox',
        align   : 'stretch'
    },

<span id='Gnt-widget-calendar-Calendar-method-initComponent'>    initComponent : function() {
</span>        var me = this;

        me.copiesIndexByOriginalId = {};

        // compiles templates
        me.setupTemplates();

        var calendar    = me.calendar;

        if (!calendar &amp;&amp; me.calendarManager) {
            calendar    = me.calendarManager.getProjectCalendar() || me.calendarManager.getRoot().firstChild;
        }

        //  we need &quot;calendarDayModel&quot; to build days override grid
        if (!me.calendarDayModel) me.calendarDayModel   = calendar &amp;&amp; calendar.getModel &amp;&amp; calendar.getModel() || calendar.model;

        // fills the panel &quot;items&quot;
        me.buildItems();

        me.bindListeners();

        me.callParent(arguments);

        // update the panel UI with active calendar data
        me.calendar &amp;&amp; me.setCalendar(me.calendar);
    },


<span id='Gnt-widget-calendar-Calendar-method-bindListeners'>    bindListeners : function () {
</span>        var me = this;

        me.on('calendarset', me.onCalendarSet);
        me.on('afterrender', me.onCalendarSet);

        me.dayGrid.on({
            selectionchange : me.onDayGridSelectionChange,
            validateedit    : me.onDayGridValidateEdit,
            edit            : me.onDayGridEdit,
            scope           : me
        });

        me.dayGrid.store.on({
            update          : me.refreshView,
            remove          : me.refreshView,
            add             : me.refreshView,
            scope           : me
        });

        me.weekGrid.on({
            selectionchange : me.onWeekGridSelectionChange,
            validateedit    : me.onWeekGridValidateEdit,
            edit            : me.onWeekGridEdit,
            scope           : me
        });

        me.weekGrid.store.on({
            update          : me.refreshView,
            remove          : me.refreshView,
            add             : me.refreshView,
            scope           : me
        });

        me.datePicker.on({
            select          : me.onDateSelect,
            scope           : me
        });
    },


<span id='Gnt-widget-calendar-Calendar-method-buildItems'>    buildItems : function () {
</span>
        this.dateInfoPanel  = new Ext.Panel({
            cls             : 'gnt-calendar-dateinfo',
            padding         : '10 10 10 10',
            columnWidth     : 0.33,
            border          : false,
            height          : 200
        });

        this.cmbParentCalendar = new Ext.form.field.ComboBox({
            name            : 'cmb_parentCalendar',
            fieldLabel      : this.L('parentCalendarText'),

            store           : new Ext.data.Store({
                fields      : [ 'Id', 'Name' ]
            }),

            queryMode       : 'local',
            displayField    : 'Name',
            valueField      : 'Id',

            editable        : false,
            emptyText       : this.L('selectParentText'),
            flex            : 1
        });

        this.buildWeekGrid();
        this.buildDayGrid();
        this.buildDatePicker();

        this.items = [
            {
                xtype       : 'container',
                layout      : 'hbox',
                pack        : 'start',
                align       : 'stretch',
                items       : [
                    {
                        xtype           : 'textfield',
                        itemId          : 'calendarName',
                        fieldLabel      : this.L('calendarNameText'),
                        margin          : '0 10 0 0',
                        flex            : 1
                    },
                    this.cmbParentCalendar
                ]
            },
            {
                layout      : 'column',
                padding     : '10 10 0 10',
                defaults    : { border : false },
                items       : [
                    {
                        columnWidth     : 0.3,
                        html            : this.legendTpl.apply({
                            workingDayText          : this.L('workingDayText'),
                            weekendsText            : this.L('weekendsText'),
                            overriddenDayText       : this.L('overriddenDayText'),
                            overriddenWeekText      : this.L('overriddenWeekText'),
                            workingDayCls           : this.workingDayCls,
                            nonWorkingDayCls        : this.nonWorkingDayCls,
                            overriddenDayCls        : this.overriddenDayCls,
                            overriddenWeekDayCls    : this.overriddenWeekDayCls
                        })
                    },
                    {
                        columnWidth     : 0.37,
                        layout          : {
                            type    : 'hbox',
                            pack    : 'center'
                        },
                        items           : [ this.datePicker ]
                    },
                    this.dateInfoPanel
                ]
            },
            {
                xtype       : 'tabpanel',
                padding     : '10 10 10 10',
                flex        : 1,
                items       : [ this.dayGrid, this.weekGrid ]
            }
        ];
    },


<span id='Gnt-widget-calendar-Calendar-method-buildDayGrid'>    buildDayGrid : function () {
</span>        var calendarDayModel = this.calendarDayModel.prototype;

        // create day overrides grid
        this.dayGrid    = new Ext.grid.Panel(Ext.apply({
            title       : this.L('dayOverridesText'),
            itemId      : 'dayGrid',
            tbar        : [
                {
                    text    : this.L('addText'),
                    itemId  : 'btnAdd',
                    action  : 'add',
                    iconCls : 'gnt-action-add',
                    handler : this.addDay,
                    scope   : this
                },
                {
                    text    : this.L('editText'),
                    itemId  : 'btnEdit',
                    action  : 'edit',
                    iconCls : 'gnt-action-edit',
                    handler : this.editDay,
                    scope: this
                },
                {
                    text    : this.L('removeText'),
                    itemId  : 'btnRemove',
                    action  : 'remove',
                    iconCls : 'gnt-action-remove',
                    handler : this.removeDay,
                    scope   : this
                }
            ],
            store       : new Gnt.data.Calendar(),
            plugins     : [ new Ext.grid.plugin.CellEditing({ clicksToEdit : 2 }) ],
            columns     : [
                {
                    header      : this.L('dayOverrideNameHeaderText'),
                    dataIndex   : calendarDayModel.nameField,
                    flex        : 1,
                    editor      : { allowBlank : false }
                },
                {
                    header      : this.L('dateText'),
                    dataIndex   : calendarDayModel.dateField,
                    width       : 100,
                    xtype       : 'datecolumn',
                    editor      : { xtype : 'datefield' }
                }
            ]
        }, this.dayGridConfig || {}));

        this.dayOverridesCalendar   = this.dayGrid.store;
    },


<span id='Gnt-widget-calendar-Calendar-method-updateGrids'>    updateGrids: function () {
</span>        this.dayGrid &amp;&amp; this.fillDaysStore();
        this.weekGrid &amp;&amp; this.fillWeeksStore();
    },


<span id='Gnt-widget-calendar-Calendar-method-buildWeekGrid'>    buildWeekGrid : function () {
</span>        // create week overrides grid
        this.weekGrid   = new Ext.grid.Panel(Ext.apply({
            title       : this.L('weekOverridesText'),
            border      : true,
            itemId      : 'weekGrid',

            plugins     : [ new Ext.grid.plugin.CellEditing({ clicksToEdit : 2 }) ],

            store       : new Ext.data.Store({
                model   : 'Gnt.model.Week'
            }),

            tbar        : [
                { text: this.L('addText'), itemId: 'btnAdd', action: 'add', iconCls: 'gnt-action-add', handler: this.addWeek, scope: this },
                { text: this.L('editText'), itemId: 'btnEdit', action: 'edit', iconCls: 'gnt-action-edit', handler: this.editWeek, scope: this },
                { text: this.L('removeText'), itemId: 'btnRemove', action: 'remove', iconCls: 'gnt-action-remove', handler: this.removeWeek, scope: this }
            ],

            columns     : [
                {
                    header      : this.L('overrideName'),
                    dataIndex   : 'name',
                    flex        : 1,
                    editor      : { allowBlank : false }
                },
                {
                    xtype       : 'datecolumn',
                    header      : this.L('startDate'),
                    dataIndex   : 'startDate',
                    width       : 100,
                    editor      : { xtype : 'datefield' }
                },
                {
                    xtype       : 'datecolumn',
                    header      : this.L('endDate'),
                    dataIndex   : 'endDate',
                    width       : 100,
                    editor      : { xtype : 'datefield' }
                }
            ]

        }, this.weekGridConfig || {}));

        this.weekOverridesStore     = this.weekGrid.store;
    },


<span id='Gnt-widget-calendar-Calendar-method-buildDatePicker'>    buildDatePicker : function() {
</span>        this.datePicker = new Gnt.widget.calendar.DatePicker(Ext.apply({
            dayOverridesCalendar    : this.dayGrid.store,
            weekOverridesStore      : this.weekGrid.store
        }, this.datePickerConfig));
    },


<span id='Gnt-widget-calendar-Calendar-method-onCalendarSet'>    onCalendarSet: function (calendar) {
</span>        // data is an array of objects and store is considered as containing a modified records
        this.weekOverridesStore.commitChanges();
    },


<span id='Gnt-widget-calendar-Calendar-method-setCalendar'>    setCalendar : function (calendar) {
</span>
        if (this.calendar) {
            this.mun(this.calendar, {
                load            : this.onCalendarChange,
                add             : this.onCalendarChange,
                remove          : this.onCalendarChange,
                update          : this.onCalendarChange,
                parentchange    : this.onParentChange,
                scope           : this
            });
        }

        this.calendar = calendar;

        if (calendar) {
            this.mon(this.calendar, {
                load            : this.onCalendarChange,
                add             : this.onCalendarChange,
                remove          : this.onCalendarChange,
                update          : this.onCalendarChange,
                parentchange    : this.onParentChange,
                scope           : this
            });
        }

        this.onCalendarChange();

        this.fireEvent('calendarset', calendar);
    },


<span id='Gnt-widget-calendar-Calendar-method-onParentChange'>    onParentChange : function () {
</span>        this.updateComboBox();
    },


<span id='Gnt-widget-calendar-Calendar-method-updateComboBox'>    updateComboBox : function () {
</span>        var me          = this,
            calendars   = [];

        // Collect records for the combobox dropdown list, all calendars except the one being edited

        if (me.calendarManager) {
            var root        = me.calendarManager.getRoot();
            var activeNode  = me.calendarManager.getNodeByCalendar(me.calendar);

            root.cascadeBy(function (item) {
                var calendar = item.getCalendar();

                if (item !== root &amp;&amp; item !== activeNode &amp;&amp; !activeNode.contains(item)) {
                    calendars.push({ Id : calendar.calendarId, Name : item.getName() || calendar.calendarId });
                }
            });

        } else {
            calendars = me.calendar.getParentableCalendars();
        }

        // fill the combobx store
        this.cmbParentCalendar.store.loadData([{ Id : -1, Name : this.L('noParentText') }].concat(calendars));

        var parent      = this.calendar &amp;&amp; this.calendar.parent,
            parentId    = parent &amp;&amp; parent.calendarId;

        this.cmbParentCalendar.setValue(parentId || -1);
    },


<span id='Gnt-widget-calendar-Calendar-method-onCalendarChange'>    onCalendarChange : function () {
</span>        this.updateComboBox();
        this.fillDaysStore();
        this.fillWeeksStore();
        this.refreshView();
    },


<span id='Gnt-widget-calendar-Calendar-method-setupTemplates'>    setupTemplates : function () {
</span>        var tplTexts    = this.L('tplTexts');

        if (!this.dateInfoTpl) {
            this.dateInfoTpl = Ext.String.format(
                '&lt;div class=&quot;gnt-calendar-overridedate&quot;&gt;' +
                    '&lt;tpl if=&quot;isWorkingDay&quot;&gt;' + tplTexts.tplWorkingHours + ' {date}:&lt;tpl else&gt;{date} ' + tplTexts.tplIsNonWorking + '&lt;/tpl&gt;' +
                '&lt;/div&gt;' +
                '&lt;ul class=&quot;gnt-calendar-availabilities&quot;&gt;' +
                    '&lt;tpl for=&quot;availability&quot;&gt;' +
                        '&lt;li&gt;{.}&lt;/li&gt;' +
                    '&lt;/tpl&gt;' +
                '&lt;/ul&gt;' +
                '&lt;span class=&quot;gnt-calendar-overridesource&quot;&gt;' + tplTexts.tplBasedOn +': ' +
                    '&lt;tpl if=&quot;override&quot;&gt;' + tplTexts.tplOverride + ' &quot;{name}&quot; ' + tplTexts.tplInCalendar + ' &quot;{calendarName}&quot;&lt;tpl else&gt;' +
                        tplTexts.tplDayInCalendar + ' &quot;{calendarName}&quot;&lt;/tpl&gt;' +
                '&lt;/span&gt;'
            );
        }

        if (!(this.dateInfoTpl instanceof Ext.Template))    this.dateInfoTpl    = new Ext.XTemplate(this.dateInfoTpl);
        if (!(this.legendTpl instanceof Ext.Template))      this.legendTpl      = new Ext.XTemplate(this.legendTpl);
    },

<span id='Gnt-widget-calendar-Calendar-method-afterRender'>    afterRender : function () {
</span>        this.callParent(arguments);

        this.onDateSelect(this.datePicker, new Date());
    },


<span id='Gnt-widget-calendar-Calendar-method-fillDaysStore'>    fillDaysStore : function () {
</span>        // only filter days with type &quot;DAY&quot; that has &quot;Date&quot; set
        var dataTemp        = Gnt.util.Data.cloneModelSet(this.calendar, function (calendarDay) {
            return (calendarDay.getType() == 'DAY' &amp;&amp; calendarDay.getDate());
        });

        this.dayOverridesCalendar.loadData(dataTemp);
    },


<span id='Gnt-widget-calendar-Calendar-method-copyCalendarDay'>    copyCalendarDay : function (calendarDay) {
</span>        var copy            = calendarDay.copy(null);

        copy.__COPYOF__     = calendarDay.getId();

        this.copiesIndexByOriginalId[ calendarDay.getId() ]   = copy.getId();

        return copy;
    },


<span id='Gnt-widget-calendar-Calendar-method-fillWeeksStore'>    fillWeeksStore : function () {
</span>        var me              = this;
        var data            = [];

        this.calendar.forEachNonStandardWeek(function (nonStandardWeek) {
            var week                = Ext.apply({}, nonStandardWeek);

            week.weekAvailability   = Ext.Array.map(week.weekAvailability, function (day) {
                return day &amp;&amp; me.copyCalendarDay(day) || null;
            });

            week.mainDay            = me.copyCalendarDay(week.mainDay);

            data.push(week);
        });

        this.weekOverridesStore.loadData(data);
    },


<span id='Gnt-widget-calendar-Calendar-method-addDay'>    addDay : function () {
</span>        var date        = this.datePicker.getValue();
        // do not allow duplicate day overrides
        if (this.dayOverridesCalendar.getOwnCalendarDay(date)) {
            this.alert({ msg : this.L('overrideErrorText') });
            return;
        }

        var dayModel    = this.calendar.model;
        var dayProto    = dayModel.prototype;
        var newDay      = {};

        newDay[dayProto.nameField] = this.L('newDayName');
        newDay[dayProto.typeField] = 'DAY';
        newDay[dayProto.dateField] = date;

        newDay              = new dayModel(newDay);

        //this.dayOverridesCalendar.insert(0, newDay);
        this.dayGrid.getStore().insert(0, newDay);
        this.dayGrid.getSelectionModel().select([ newDay ], false, false);
    },


<span id='Gnt-widget-calendar-Calendar-method-editDay'>    editDay : function () {
</span>        var me          = this,
            selection   = this.dayGrid.getSelection(),
            day         = selection[ 0 ];

        if (day) {

            var editor  = this.currentDayOverrideEditor = new Gnt.widget.calendar.DayEditor({
                addText             : this.L('addText'),
                removeText          : this.L('removeText'),
                workingTimeText     : this.L('workingTimeText'),
                nonworkingTimeText  : this.L('nonworkingTimeText'),
                calendarDay         : day
            });

            var editorWindow      = Ext.create('Ext.window.Window', {
                title           : this.L('dayOverridesText'),
                modal           : true,

                width           : 280,
                height          : 260,

                layout          : 'fit',
                items           : editor,

                buttons         : [
                    {
                        text        : this.L('okText'),
                        handler     : function () {
                            if (editor.isValid()) {
                                var calendarDay = editor.calendarDay;

                                calendarDay.setIsWorkingDay(editor.isWorkingDay());
                                calendarDay.setAvailability(editor.getIntervals());

                                me.applyCalendarDay(calendarDay, day);

                                me.refreshView();

                                editorWindow.close();
                            }
                        }
                    },
                    {
                        text        : this.L('cancelText'),
                        handler     : function () {
                            editorWindow.close();
                        }
                    }
                ]
            });

            editorWindow.show();
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-removeDay'>    removeDay : function () {
</span>        var grid        = this.dayGrid,
            selection   = grid.getSelection();

        if (!selection[0]) return;

        grid.getStore().remove(selection[0]);

        this.refreshView();
    },


<span id='Gnt-widget-calendar-Calendar-method-refreshView'>    refreshView : function () {
</span>        var date        = this.datePicker.getValue(),
            day         = this.getCalendarDay(date),
            weekGrid    = this.weekGrid,
            dayGrid     = this.dayGrid,
            dayOverride = this.dayOverridesCalendar.getOwnCalendarDay(date),
            weekOverride;

        var name;

        // First check if there is an override on day level
        if (dayOverride) {
            dayGrid.getSelectionModel().select([ dayOverride ], false, true);
            name        = dayOverride.getName();
        } else {
            // Now check if there is an override on week level
            weekOverride = this.getWeekOverrideByDate(date);
            if (weekOverride) {
                weekGrid.getSelectionModel().select([ weekOverride ], false, true);
                name    = weekOverride.get('name');
            }
        }

        var dayData = {
            name            : name || day.getName(),
            date            : Ext.Date.format(date, 'M j, Y'),
            calendarName    : this.calendar.name || this.calendar.calendarId,
            availability    : day.getAvailability(true),
            override        : Boolean(dayOverride || weekOverride),
            isWorkingDay    : day.getIsWorkingDay()
        };

        this.dateInfoPanel.update(this.dateInfoTpl.apply(dayData));

        this.down('#calendarName').setValue(this.calendar.name);

        this.datePicker.rendered &amp;&amp; this.datePicker.refreshCssClasses();
    },


<span id='Gnt-widget-calendar-Calendar-method-onDayGridSelectionChange'>    onDayGridSelectionChange : function (grid, selection) {
</span>        if (selection[0]) {
            this.datePicker.setValue(selection[0].getDate());
            this.refreshView();
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-onDayGridEdit'>    onDayGridEdit : function (editor, context) {
</span>        if (context.field === 'Date') {
            context.grid.getStore().clearCache();
            this.datePicker.setValue(context.value);
        }

        this.refreshView();
    },


<span id='Gnt-widget-calendar-Calendar-method-onDayGridValidateEdit'>    onDayGridValidateEdit : function (editor, context) {
</span>        var calendar = this.dayGrid.store;

        if (context.field === calendar.model.prototype.dateField &amp;&amp; calendar.getOwnCalendarDay(context.value) &amp;&amp; context.value !== context.originalValue) {
            this.alert({ msg : this.L('overrideErrorText') });
            return false;
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-onDateSelect'>    onDateSelect : function (picker, date) {
</span>        this.refreshView();
    },


<span id='Gnt-widget-calendar-Calendar-method-getCalendarDay'>    getCalendarDay: function (date) {
</span>        var day     = this.dayOverridesCalendar.getOwnCalendarDay(date);

        if (day) return day;

        day         = this.getWeekOverrideDay(date);

        if (day) return day;

        return this.calendar.weekAvailability[ date.getDay() ] || this.calendar.defaultWeekAvailability[ date.getDay() ];
    },


<span id='Gnt-widget-calendar-Calendar-method-getWeekOverrideDay'>    getWeekOverrideDay : function (date) {
</span>        var dateTime            = new Date(date),
            internalWeekModel   = this.getWeekOverrideByDate(date),
            index               = dateTime.getDay();

        if (internalWeekModel == null) return null;

        var weekAvailability = internalWeekModel.get('weekAvailability');

        if (!weekAvailability) return null;

        return weekAvailability[ index ];
    },


<span id='Gnt-widget-calendar-Calendar-method-getWeekOverrideByDate'>    getWeekOverrideByDate: function(date) {
</span>        var week = null;

        this.weekOverridesStore.each(function (internalWeekModel) {
            if (Ext.Date.between(date, internalWeekModel.get('startDate'), internalWeekModel.get('endDate'))) {
                week = internalWeekModel;
                return false;
            }
        });

        return week;
    },


<span id='Gnt-widget-calendar-Calendar-method-intersectsWithCurrentWeeks'>    intersectsWithCurrentWeeks : function (startDate, endDate, except) {
</span>        var result                          = false;

        this.weekOverridesStore.each(function (internalWeekModel) {
            if (internalWeekModel == except) return;

            var weekStartDate       = internalWeekModel.get('startDate');
            var weekEndDate         = internalWeekModel.get('endDate');

            if (weekStartDate &lt;= startDate &amp;&amp; startDate &lt; weekEndDate || weekStartDate &lt; endDate &amp;&amp; endDate &lt;= weekEndDate) {
                result      = true;

                // stop the iteration
                return false;
            }
        });

        return result;
    },


<span id='Gnt-widget-calendar-Calendar-method-addWeek'>    addWeek : function () {
</span>        var weekOverridesStore      = this.weekOverridesStore;
        var startDate               = this.datePicker.getValue();
        var endDate;

        // we are about to create a week override and we need to make sure it does not
        // intersect with already created week overrides. Also we'd like to make it 1w long initially
        // but in case there will be an intersection with current overrides we are ok to shorten it
        for (var duration = 7; duration &gt; 0; duration--) {
            endDate     = Sch.util.Date.add(startDate, Sch.util.Date.DAY, duration);

            if (!this.intersectsWithCurrentWeeks(startDate, endDate)) break;
        }

        if (!duration) {
            this.alert({ msg : Ext.String.format(this.L('overrideDateError'), Ext.Date.format(startDate, 'Y/m/d')) });
            return;
        }

        var mainDay     = new this.calendar.model();

        mainDay.setType('WEEKDAYOVERRIDE');
        mainDay.setName(this.L('newDayName'));
        mainDay.setOverrideStartDate(startDate);
        mainDay.setOverrideEndDate(endDate);
        mainDay.setWeekday(-1);

        var newWeek                 = weekOverridesStore.insert(0, {
            name                : this.L('newDayName'),
            startDate           : startDate,
            endDate             : endDate,

            weekAvailability    : [],
            mainDay             : mainDay
        })[ 0 ];

        this.weekGrid.getSelectionModel().select([ newWeek ], false, false);
    },


<span id='Gnt-widget-calendar-Calendar-method-editWeek'>    editWeek : function () {
</span>        var selection   = this.weekGrid.getSelection(),
            me          = this;

        if (selection.length === 0) return;

        var weekModel   = selection[ 0 ];

        var editor      = new Gnt.widget.calendar.WeekEditor({
            startDate                   : weekModel.get('startDate'),
            endDate                     : weekModel.get('endDate'),
            weekName                    : weekModel.get('name'),
            calendarDayModel            : this.calendar.model,
            // keep the &quot;weekModel&quot; private and pass individual fields to the editor
            weekAvailability            : weekModel.get('weekAvailability'),
            calendarWeekAvailability    : this.calendar.weekAvailability,
            defaultWeekAvailability     : this.calendar.defaultWeekAvailability
        });

        var editorWindow    = Ext.create('Ext.window.Window', {
            title       : this.L('weekOverridesText'),
            modal       : true,
            width       : 370,
            defaults    : { border : false },

            layout      : 'fit',
            items       : editor,

            buttons     : [
                {
                    // this property will be used in test to locate the button
                    action      : 'ok',

                    text        : this.L('okText'),
                    handler     : function () {
                        if (editor.applyChanges(weekModel.get('weekAvailability'))) {
                            me.refreshView();
                            editorWindow.close();
                        }
                    }
                },
                {
                    text        : this.L('cancelText'),
                    handler     : function() {
                        editorWindow.close();
                    }
                }
            ]
        });

        editorWindow.show();
    },


<span id='Gnt-widget-calendar-Calendar-method-removeWeek'>    removeWeek : function () {
</span>        var selection   = this.weekGrid.getSelection();

        if (selection[0]) {
            this.weekOverridesStore.remove(selection[ 0 ]);
            this.refreshView();
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-onWeekGridSelectionChange'>    onWeekGridSelectionChange : function (grid, selection) {
</span>        if (selection[0]) {
            this.datePicker.setValue(selection[0].get('startDate'));
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-onWeekGridEdit'>    onWeekGridEdit : function (editor, context) {
</span>        var weekModel       = context.record,
            startDate       = weekModel.get('startDate'),
            endDate         = weekModel.get('endDate');

        if (context.field == 'startDate' || context.field == 'endDate') {
            Ext.Array.each(weekModel.get('weekAvailability').concat(weekModel.get('mainDay')), function (weekDay) {
                if (weekDay) {
                    weekDay.setOverrideStartDate(startDate);
                    weekDay.setOverrideEndDate(endDate);
                }
            });

            this.datePicker.setValue(startDate);
        }

//        if (context.field == 'name') {
//            weekModel.setName(weekModel.getName());
//            Ext.Array.each(weekModel.get('weekAvailability').concat(weekModel.get('mainDay')), function (weekDay) {
//                if (weekDay) {
//                    weekDay.setName(weekModel.get('name'));
//                }
//            });
//        }

        this.refreshView();
    },

<span id='Gnt-widget-calendar-Calendar-method-alert'>    alert : function (config) {
</span>        config = config || {};

        Ext.MessageBox.show(Ext.applyIf(config, {
            title       : this.L('error'),
            icon        : Ext.MessageBox.WARNING,
            buttons     : Ext.MessageBox.OK
        }));
    },

<span id='Gnt-widget-calendar-Calendar-method-onWeekGridValidateEdit'>    onWeekGridValidateEdit : function (editor, context) {
</span>        var weekModel            = context.record,
            startDate            = context.field == 'startDate' ? context.value : weekModel.get('startDate'),
            endDate              = context.field == 'endDate' ? context.value : weekModel.get('endDate');

        if (startDate &gt; endDate) {
            this.alert({ msg : this.L('startAfterEndError') });
            return false;
        }

        if (this.intersectsWithCurrentWeeks(startDate, endDate, weekModel)) {
            this.alert({ msg : this.L('weeksIntersectError') });
            return false;
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-applyCalendarDay'>    applyCalendarDay : function (from, to) {
</span>        to.beginEdit();

        to.setName(from.getName());
        to.setIsWorkingDay(from.getIsWorkingDay());
        to.setDate(from.getDate());
        to.setOverrideStartDate(from.getOverrideStartDate());
        to.setOverrideEndDate(from.getOverrideEndDate());

        var fromAvailability    = from.getAvailability(true);
        var toAvailability      = to.getAvailability(true);

        if (fromAvailability + '' != toAvailability + '') to.setAvailability(from.getAvailability());

        to.endEdit();
    },


<span id='Gnt-widget-calendar-Calendar-method-applySingleDay'>    applySingleDay : function (copyDay, toAdd) {
</span>        if (copyDay.__COPYOF__) {
            this.applyCalendarDay(copyDay, this.calendar.getModelByInternalId(copyDay.__COPYOF__));
        } else {
            if (copyDay.joined) {
                copyDay.unjoin(copyDay.joined[ 0 ]);
            }
            // we reset id to not intersect w/ existing records
            copyDay.setId(null);
            toAdd.push(copyDay.getData());
        }
    },


<span id='Gnt-widget-calendar-Calendar-method-applyChanges'>    /**
</span>     * Call this method when user is satisfied with the current state of the calendar in the UI. It will apply all the changes made in the UI
     * to the original calendar.
     *
     */
    applyChanges : function () {
        var me              = this;
        var calendar        = this.calendar;
        var parent          = this.down('combobox[name=&quot;cmb_parentCalendar&quot;]').getValue(),
            newName         = this.down('#calendarName').getValue();

        if (this.calendarManager) {
            var node = this.calendarManager.getModelById(calendar.calendarId);
            if (node) {
                node.setName(newName);
            }
        }

        calendar.suspendEvents(true);
        calendar.suspendCacheUpdate++;

        calendar.name = newName;

        calendar.setParent(parent ? Gnt.data.Calendar.getCalendar(parent) : null);

        if (calendar.proxy.extraParams) {
            calendar.proxy.extraParams.calendarId   = calendar.calendarId;
        }

        // days part
        Gnt.util.Data.applyCloneChanges(this.dayOverridesCalendar, calendar);

        var daysToAdd               = [];
        var daysToRemove            = [];
        var remainingWeekDays       = {};

        // weeks part
        this.weekOverridesStore.each(function (weekModel) {
            Ext.Array.each(weekModel.get('weekAvailability').concat(weekModel.get('mainDay')), function (weekDay) {
                if (weekDay) {
                    if (weekDay.__COPYOF__) remainingWeekDays[ weekDay.__COPYOF__ ] = true;

                    me.applySingleDay(weekDay, daysToAdd);
                }
            });
        });

        calendar.forEachNonStandardWeek(function (originalWeek) {
            Ext.Array.each(originalWeek.weekAvailability.concat(originalWeek.mainDay), function (originalWeekDay) {
                if (originalWeekDay &amp;&amp; !remainingWeekDays[ originalWeekDay.getId() ]) daysToRemove.push(originalWeekDay);
            });
        });

        calendar.add(daysToAdd);
        calendar.remove(daysToRemove);

        calendar.suspendCacheUpdate--;
        calendar.clearCache();

        calendar.resumeEvents();

        this.fireEvent('calendarset', calendar);
    },


<span id='Gnt-widget-calendar-Calendar-method-hasChanges'>    hasChanges    : function () {
</span>        if (!this.calendar) return false;

        var dayChanges      = this.dayOverridesCalendar.getModifiedRecords().length || this.dayOverridesCalendar.getRemovedRecords().length,
            weekChanges     = this.weekOverridesStore.getModifiedRecords().length || this.weekOverridesStore.getRemovedRecords().length,
            // isDirty on field wouldn't work correct, so we are going to check it differently
            nameChanged     = this.down('#calendarName').getValue() != this.calendar.name,
            parentId        = this.calendar.parent &amp;&amp; this.calendar.parent.calendarId || -1,
            parentChanged   = this.cmbParentCalendar.getValue() != parentId;

        return dayChanges || weekChanges || nameChanged || parentChanged;
    }
});
</pre>
</body>
</html>
