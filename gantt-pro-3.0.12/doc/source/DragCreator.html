<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Gnt-feature-DragCreator'>/**
</span> * @class Gnt.feature.DragCreator
 * @private
 *
 * An internal class which shows a drag proxy while clicking and dragging.
 * Create a new instance of this plugin
 */
Ext.define(&quot;Gnt.feature.DragCreator&quot;, {
    requires         : [
        'Ext.Template',
        'Sch.util.DragTracker',
        'Gnt.Tooltip'
    ],

<span id='Gnt-feature-DragCreator-cfg-disabled'>    /**
</span>     * @cfg {Boolean} disabled true to start disabled
     */
    disabled         : false,

<span id='Gnt-feature-DragCreator-cfg-showDragTip'>    /**
</span>     * @cfg {Boolean} showDragTip true to show a time tooltip when dragging to create a new event
     */
    showDragTip      : true,

<span id='Gnt-feature-DragCreator-cfg-tooltipConfig'>    /**
</span>     * @cfg {Object} tooltipConfig A custom config object to apply to the {@link Gnt.Tooltip} instance.
     */
    tooltipConfig    : null,

<span id='Gnt-feature-DragCreator-cfg-dragTolerance'>    /**
</span>     * @cfg {Number} dragTolerance Number of pixels the drag target must be moved before dragging is considered to have started.
     */
    dragTolerance    : 2,

<span id='Gnt-feature-DragCreator-cfg-template'>    /**
</span>     * @cfg {Ext.Template} template The HTML template shown when dragging to create new items
     */

<span id='Gnt-feature-DragCreator-cfg-validatorFn'>    /**
</span>     * @cfg {Function} validatorFn An empty function by default.
     * Provide to perform custom validation on the item being created.
     * @param {Ext.data.Model} record the resource for which the task is being created
     * @param {Date} startDate
     * @param {Date} endDate
     * @param {Event} e The event object
     * @return {Boolean} isValid True if the creation event is valid, else false to cancel
     */
    validatorFn      : Ext.emptyFn,

<span id='Gnt-feature-DragCreator-cfg-validatorFnScope'>    /**
</span>    * @cfg {Object} validatorFnScope
    * The scope for the {@link #validatorFn}
    */
    validatorFnScope : null,

<span id='Gnt-feature-DragCreator-method-constructor'>    constructor : function (config) {
</span>        Ext.apply(this, config || {});

        this.init();
    },

<span id='Gnt-feature-DragCreator-method-setDisabled'>    /**
</span>    * Enables/disables the plugin
    * @param {Boolean} disabled True to disable this plugin
    */
    setDisabled : function (disabled) {
        this.disabled = disabled;
        if (this.dragTip) {
            this.dragTip.setDisabled(disabled);
        }
    },

<span id='Gnt-feature-DragCreator-method-getProxy'>    getProxy : function () {
</span>        if (!this.proxy) {
            // Attach this element to the nested gantt panel element (view el is cleared by refreshes)
            this.proxy = this.template.append(this.ganttView.ownerCt.el, {}, true);
        }
        return this.proxy;
    },

<span id='Gnt-feature-DragCreator-method-onBeforeDragStart'>    // private
</span>    onBeforeDragStart : function (e) {
        var s = this.ganttView,
            t = e.getTarget('.' + s.timeCellCls, 2);

        if (t &amp;&amp; !this.disabled) {
            var record   = s.resolveTaskRecord(t);
            var dateTime = s.getDateFromDomEvent(e);

            if (!record.isReadOnly() &amp;&amp; !record.getStartDate() &amp;&amp; !record.getEndDate() &amp;&amp; s.fireEvent('beforedragcreate', s, record, dateTime, e) !== false) {

                e.stopEvent();

                // Save record if the user ends the drag outside the current row
                this.record = record;

                // Start time of the task to be created
                this.originalStart = dateTime;

                // Constrain the dragging within the current row schedule area
                this.rowRegion = s.getScheduleRegion(this.record, this.originalStart);

                // Save date constraints
                this.dateConstraints = s.getDateConstraints(this.resourceRecord, this.originalStart);

                // TODO apply xStep or yStep to drag tracker
                return true;
            }
        }
        return false;
    },

<span id='Gnt-feature-DragCreator-method-onDragStart'>    // private
</span>    onDragStart : function () {
        var me    = this,
            view  = me.ganttView,
            proxy = me.getProxy();

        me.start = me.originalStart;
        me.end   = me.start;

        me.rowBoundaries = {
            top    : me.rowRegion.top,
            bottom : me.rowRegion.bottom
        };

        proxy.setBox({
            x      : me.tracker.startXY[0],
            y      : me.rowBoundaries.top,
            width  : 1,
            height : me.rowBoundaries.bottom - me.rowBoundaries.top
        });

        proxy.show();

        view.fireEvent('dragcreatestart', view);

        if (me.showDragTip) {
            me.dragTip.updateContent(me.start, me.end, true, me.record);
            me.dragTip.enable();
            me.dragTip.show(proxy);
        }
    },

<span id='Gnt-feature-DragCreator-method-onDrag'>    // private
</span>    onDrag : function (e) {
        var me         = this,
            view       = me.ganttView,
            dragRegion = me.tracker.getRegion().constrainTo(me.rowRegion),
            dates      = view.getStartEndDatesFromRegion(dragRegion, 'round');

        if (!dates) {
            return;
        }

        me.start = dates.start || me.start;
        me.end   = dates.end || me.end;

        var dc = me.dateConstraints;

        if (dc) {
            me.end   = Sch.util.Date.constrain(me.end, dc.start, dc.end);
            me.start = Sch.util.Date.constrain(me.start, dc.start, dc.end);
        }

        me.valid = me.validatorFn.call(me.validatorFnScope || me, me.record, me.start, me.end, e) !== false;

        if (me.showDragTip) {
            me.dragTip.updateContent(me.start, me.end, me.valid, me.record);
        }

        Ext.apply(dragRegion, me.rowBoundaries);

        me.getProxy().setBox(dragRegion);
    },

<span id='Gnt-feature-DragCreator-method-onDragEnd'>    // private
</span>    onDragEnd : function (e) {
        var me         = this,
            view       = me.ganttView,
            doFinalize = false;

        me.createContext = {
            start    : me.start,
            end      : me.end,
            e        : e,
            record   : me.record,
            finalize : function () {
                me.finalize.apply(me, arguments);
            }
        };

        if (me.showDragTip) {
            me.dragTip.disable();
        }

        if (!me.start || !me.end || (me.end &lt; me.start)) {
            me.valid = false;
        }

        if (me.valid) {
            doFinalize = view.fireEvent('beforedragcreatefinalize', me, me.createContext, e) !== false;
        }

        if (doFinalize) {
            me.finalize(me.valid);
        }
    },

<span id='Gnt-feature-DragCreator-method-finalize'>    finalize : function (doCreate) {
</span>        var me      = this,
            context = me.createContext,
            view    = me.ganttView;

        if (doCreate) {
            context.record.setStartEndDate(context.start, context.end, context.record.getTaskStore().skipWeekendsDuringDragDrop);
            view.fireEvent('dragcreateend', view, context.record, context.e);
        }

        me.proxy.hide();

        view.fireEvent('afterdragcreate', view);
    },

<span id='Gnt-feature-DragCreator-method-init'>    // private
</span>    init : function () {
        var view           = this.ganttView,
            gridViewBodyEl = view.el,
            bind           = Ext.Function.bind;

        this.lastTime = new Date();
        this.template = this.template || Ext.create(&quot;Ext.Template&quot;,
            '&lt;div class=&quot;sch-gantt-dragcreator-proxy&quot;&gt;&lt;/div&gt;',
            {
                compiled       : true,
                disableFormats : true
            }
        );

        view.on({
            destroy : this.onGanttDestroy,
            scope   : this
        });

        this.tracker = new Sch.util.DragTracker({
            el            : gridViewBodyEl,
            tolerance     : this.dragTolerance,
            onBeforeStart : bind(this.onBeforeDragStart, this),
            onStart       : bind(this.onDragStart, this),
            onDrag        : bind(this.onDrag, this),
            onEnd         : bind(this.onDragEnd, this)
        });

        if (this.showDragTip) {
            this.dragTip = new Gnt.Tooltip(Ext.apply({
                mode    : 'duration',
                cls     : 'sch-gantt-dragcreate-tip',
                gantt   : view
            }, this.tooltipConfig));
        }
    },

<span id='Gnt-feature-DragCreator-method-onGanttDestroy'>    onGanttDestroy : function () {
</span>        if (this.dragTip) {
            this.dragTip.destroy();
        }

        if (this.tracker) {
            this.tracker.destroy();
        }

        if (this.proxy) {
            Ext.destroy(this.proxy);
            this.proxy = null;
        }
    }
});
</pre>
</body>
</html>
