<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Gnt-plugin-ConstraintResolutionGui'>/**
</span> * @class   Gnt.plugin.ConstraintResolutionGui
 * @extends Ext.AbstractPlugin
 */
Ext.define(&quot;Gnt.plugin.ConstraintResolutionGui&quot;, {
    extend   : &quot;Ext.AbstractPlugin&quot;,
    alias    : &quot;plugin.constraintresolutiongui&quot;,
    requires : [&quot;Gnt.widget.ConstraintResolutionWindow&quot;],

    config : {
<span id='Gnt-plugin-ConstraintResolutionGui-cfg-dateFormat'>        /**
</span>         * @cfg {String} dateFormat
         *
         * Date format to pass to {@link Gnt.widget.ConstraintResolutionWindow}
         */
        dateFormat : null
    },

<span id='Gnt-plugin-ConstraintResolutionGui-property-cmpDetacher'>    cmpDetacher         : null,
</span><span id='Gnt-plugin-ConstraintResolutionGui-property-storeDetacher'>    storeDetacher       : null,
</span><span id='Gnt-plugin-ConstraintResolutionGui-property-storedResolutions'>    storedResolutions   : null,
</span>
<span id='Gnt-plugin-ConstraintResolutionGui-method-constructor'>    constructor : function(config) {
</span>        var me = this;

        if (Ext.Version.compare(Ext.versions.extjs, '5.0.0') == -1) {
            me.initConfig(config);
        }

        me.callParent([config]);
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-init'>    init : function(cmp) {
</span>        var me = this;

        me.callParent(arguments);

        if (!me.disabled) {
            me.enable();
        }
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-enable'>    enable : function() {
</span>        var me = this,
            cmp = me.getCmp();

        me.callParent();

        // This is a GUI class, let's wait for the Gantt view to render first
        if (cmp.rendered) {
            me.attachToTaskStore();
        }
        else {
            me.cmpDetacher = cmp.on('afterrender', function() {
                me.attachToTaskStore();
            }, null, { destroyable : true, single : true });
        }
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-disable'>    disable : function() {
</span>        var me = this,
            cmp = me.getCmp();

        me.callParent();

        if (cmp.rendered) {
            me.detachFromTaskStore();
        }
        else {
            me.cmpDetacher &amp;&amp; Ext.destroy(me.cmpDetacher);
            me.cmpDetacher = null;
        }
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-attachToTaskStore'>    attachToTaskStore : function() {
</span>        var me = this,
            cmp, store;

        if (!me.storeDetacher) {
            cmp   = me.getCmp();
            store = cmp.getTaskStore();
            me.storeDetacher = cmp.mon(store, 'constraintconflict', me.onConstraintConflict, me, { destroyable : true });
        }
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-detachFromTaskStore'>    detachFromTaskStore : function() {
</span>        var me = this;
        me.storeDetacher &amp;&amp; Ext.destroy(me.storeDetacher);
        me.storeDetacher = null;
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-onConstraintConflict'>    onConstraintConflict : function(task, resolutionContext) {
</span>        var me         = this,
            ganttPanel = me.getCmp(),
            lockedView = ganttPanel.lockedGrid.getView(),
            normalView = ganttPanel.normalGrid.getView(),
            depView    = ganttPanel.getDependencyView(),
            taskIdx    = normalView.indexOf(task),
            wnd,
            detacher, detacherWrapper = {
                destroy : function() {
                    Ext.destroy(detacher);
                }
            };

        // Redrawing the conflicting task row and dependencies
        function redrawTask() {
            if (taskIdx != -1) {
                lockedView.refreshNode(taskIdx);
                normalView.refreshNode(taskIdx);
                depView.updateDependencies(task);
            }
        }

        redrawTask();

        if (!me.hasStoredResolutionForContext(resolutionContext)) {
            wnd = new Gnt.widget.ConstraintResolutionWindow({
                dateFormat        : me.getDateFormat(),
                resolutionContext : resolutionContext
            });

            detacher = wnd.on({
                'ok'        : Ext.Function.bind(me.onUserActionOk,     me, [resolutionContext, redrawTask, wnd, detacherWrapper], true),
                'cancel'    : Ext.Function.bind(me.onUserActionCancel, me, [resolutionContext, redrawTask, wnd, detacherWrapper], true),
                'close'     : Ext.Function.bind(me.onUserActionClose,  me, [resolutionContext, redrawTask, detacherWrapper],      true),

                scope       : me,
                destroyable : true
            });

            ganttPanel.completeEdit();

            wnd.show();
        }
        else {
            me.resolveSilently(resolutionContext, redrawTask);
        }
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-getStoredResolutions'>    getStoredResolutions : function() {
</span>        var me = this;

        if (!me.storedResolutions) {
            me.storedResolutions = {};
        }
        return me.storedResolutions;
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-getStoredResolutionKeyForContext'>    getStoredResolutionKeyForContext : function(resolutionContext) {
</span>        // &lt;debug&gt;
        Ext.isObject(resolutionContext) &amp;&amp; Ext.isString(resolutionContext.title) &amp;&amp; Ext.isArray(resolutionContext.resolutions) ||
            Ext.Error.raise(&quot;Can't get stored resolution key for context, invalid context is given!&quot;);
        // &lt;/debug&gt;

        return resolutionContext.title + resolutionContext.resolutions.length;
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-hasStoredResolutionForContext'>    hasStoredResolutionForContext : function(resolutionContext) {
</span>        var me = this,
            key = me.getStoredResolutionKeyForContext(resolutionContext),
            storedResolutions = me.getStoredResolutions();

        return Ext.isDefined(storedResolutions[key]);
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-getStoredResolutionForContext'>    getStoredResolutionForContext : function(resolutionContext) {
</span>        var me = this,
            key = me.getStoredResolutionKeyForContext(resolutionContext),
            storedResolutions = me.getStoredResolutions();

        // &lt;debug&gt;
        Ext.isDefined(storedResolutions[key]) ||
            Ext.Error.raise(&quot;Can't get resolution for context, no resolutions has been stored previously!&quot;);
        // &lt;/debug&gt;

        return storedResolutions[key];
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-storeResolutionForContext'>    storeResolutionForContext : function(resolutionContext, optionIndex) {
</span>        var me = this,
            key = me.getStoredResolutionKeyForContext(resolutionContext),
            storedResolutions = me.storedResolutions;

        me.storedResolutions[key] = optionIndex;
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-resolveSilently'>    resolveSilently : function(resolutionContext, redrawTaskFn) {
</span>        var me = this,
            optionIndex = me.getStoredResolutionForContext(resolutionContext);

        // &lt;debug&gt;
        Ext.isObject(resolutionContext) &amp;&amp; Ext.isArray(resolutionContext.resolutions) &amp;&amp; Ext.isDefined(resolutionContext.resolutions[optionIndex]) ||
            Ext.Error.raise(&quot;Can't resolve constraint confict silently, stored resolution is inconsistent to the context given!&quot;);
        // &lt;/debug&gt;

        resolutionContext.resolutions[optionIndex].resolve();

        // Redrawing the conflicting task again after user has decided what to do
        redrawTaskFn();
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-onUserActionOk'>    onUserActionOk : function(form, userChoise, eOpts, resolutionContext, redrawTaskFn, wnd, detacher) {
</span>        var me = this;

        // &lt;debug&gt;
        Ext.isObject(userChoise) &amp;&amp;
        Ext.isDefined(userChoise.resolutionOption) &amp;&amp;
        Ext.isDefined(userChoise.dontAsk) ||
            Ext.Error.raise(&quot;Can't resolve constraint conflict according to user choise, user choise is invalid!&quot;);

        Ext.isObject(resolutionContext) &amp;&amp;
        Ext.isArray(resolutionContext.resolutions) &amp;&amp;
        Ext.isDefined(resolutionContext.resolutions[userChoise.resolutionOption]) ||
            Ext.Error.raise(&quot;Can't resolve constraint conflict according to user choise, resolution context is inconsistent to user choise!&quot;);
        // &lt;/debug&gt;

        Ext.destroy(detacher);
        wnd.close();

        if (userChoise.dontAsk) {
            me.storeResolutionForContext(resolutionContext, userChoise.resolutionOption);
        }

        resolutionContext.resolutions[userChoise.resolutionOption].resolve();

        // Redrawing the conflicting task again after user has decided what to do
        redrawTaskFn();
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-onUserActionCancel'>    onUserActionCancel : function(form, eOpts, resolutionContext, redrawTaskFn, wnd, detacher) {
</span>        var me = this;

        // &lt;debug&gt;
        Ext.isObject(resolutionContext) &amp;&amp; Ext.isFunction(resolutionContext.cancelAction) ||
            Ext.Error.raise(&quot;Invalid resolution context given!&quot;);
        // &lt;/debug&gt;

        Ext.destroy(detacher);
        wnd.close();

        resolutionContext.cancelAction();

        // Redrawing the conflicting task again after user has decided what to do
        redrawTaskFn();
    },

<span id='Gnt-plugin-ConstraintResolutionGui-method-onUserActionClose'>    onUserActionClose : function(wnd, eOpts, resolutionContext, redrawTaskFn, detacher) {
</span>        var me = this;

        // &lt;debug&gt;
        resolutionContext &amp;&amp; Ext.isFunction(resolutionContext.cancelAction) ||
            Ext.Error.raise(&quot;Invalid resolution context given!&quot;);
        // &lt;/debug&gt;

        Ext.destroy(detacher);

        resolutionContext.cancelAction();

        // Redrawing the conflicting task again after user has decided what to do
        redrawTaskFn();
    }
});
</pre>
</body>
</html>
