<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Gnt-model-CalendarDay'>/**
</span>
@class Gnt.model.CalendarDay
@extends Sch.model.Customizable

A model representing a single day in the calendar. Depending from the `Type` field, day may be a concrete day per se (2012/01/01),
a certain weekday (all Thursdays), or an override for all certain weekdays in the timeframe
(all Fridays between 2012/01/01 - 2012/01/15, inclusive).

A collection CalendarDay instances is supposed to be provided for the {@link Gnt.data.Calendar calendar}

Fields
------

- `Id`   - The id of the date. Can be an arbitrary unique value, assigned by the server. For backward compatibility, if this field has one of the special formats
then some data will be extracted from it. This behavior will be kept for several coming releases, but you should not rely on it anymore.
- `Type` - The type of this calendar day. Can be one of the following `DAY`, `WEEKDAY`, `WEEKDAYOVERRIDE`:
    - Default value is `DAY` meaning this day represents a &quot;real&quot; day in the calendar (2012/01/01 for example) and contains availability information for that particular day only.
    The date is stored in the `Date` field.
    - The `WEEKDAY` value means calendar day contains information about all weekdays with the index, given in the `Weekday` field (0 - Sunday, 1 - Monday and so on).
    For example - all Fridays. `Date` field is ignored.
    - &lt;p&gt;The `WEEKDAYOVERRIDE` value means calendar day contains information about all weekdays within certain timespan. For example - all Fridays between 2012/01/01 - 2012/01/15.
    Week day index should be stored in the `Weekday` field again, beginning of the timespan - in the `OverrideStartDate` field and the end of timespan - in the `OverrideEndDate`.
    &lt;/p&gt;
    &lt;p&gt;
    A single day instance contains the override for a single week day. So, to define overrides for several days (Monday and Tuesday for example) - add an additional instance
    to the calendar with the same `Name/OverrideStartDate/OverrideEndDate` values. There's no need to define an override for every weekday - if some day is not defined - the
    default availability will be used.
    &lt;/p&gt;
    &lt;p&gt;
    * **Note** Every week override should also have a &quot;main&quot; calendar day instance, representing the override itself. It should have the same
    values for `Name/OverrideStartDate/OverrideEndDate` fields and -1 for `Weekday`. Also, the timespans of all week overrides should not intersect.
    &lt;/p&gt;
    &lt;p&gt;
    To avoid manual creation of week overrides you can use the calendar API (for example, {@link Gnt.data.Calendar#addNonStandardWeek addNonStandardWeek},
    {@link Gnt.data.Calendar#removeNonStandardWeek removeNonStandardWeek} methods), or use a special widget: {@link Gnt.widget.calendar.Calendar}
    &lt;/p&gt;

- `Date` - the date for this day in the ISO 8601 format. Any time information in this field will be cleared. If this instance
  represents a weekday or week override, this field will be ignored.
- `Weekday` - the index of the week day (0 - Sunday, 1 - Monday and so on) if this instance contains information about the week day (applicable for `WEEKDAY` and `WEEKDAYOVERRIDE`).
Should be set to -1 for the &quot;main&quot; instance of the week overrides.
- `OverrideStartDate` - The start date of the timespan for week day override.
- `OverrideEndDate` - The end date of the timespan for week day override.
- `Name` - optional name of the day (holiday name for example)
- `Cls` - optional name of the CSS class, which can be used by various plugins working with weekends and holidays. Default value is `gnt-holiday`
If a holiday lasts for several days, then all days should have the same `Cls` value.
- `IsWorkingDay` - optional boolean flag, allowing you to specify exceptions - working days which falls on weekends. Default value is `false`. **Please note**, that simply setting this
field to &quot;true&quot; is not enough - you also need to specify the exact hours that are available for work with the `Availability` field (see below).
- `Availability` - should be an array of strings, containing the hourly availability for this day. Strings should have the following format:

        // two working intervals
        [ '08:00-12:00', '13:00-17:00' ]

        // whole 24 hours are available
        [ '00:00-24:00' ]
* **Please note**, that this field overrides the `IsWorkingDay` - for example, a day with &quot;IsWorkingDay : false&quot; and &quot;Availability : [ '08:00-12:00' ]&quot; - will be considered as
working day.

The name of any field can be customized in the subclass. Please refer to {@link Sch.model.Customizable} for details.

*/
Ext.define('Gnt.model.CalendarDay', {

    requires    : [ 'Ext.data.Types' ],

    extend      : 'Sch.model.Customizable',

<span id='Gnt-model-CalendarDay-property-idProperty'>    idProperty  : 'Id',
</span>
<span id='Gnt-model-CalendarDay-cfg-customizableFields'>    customizableFields      : [
</span><span id='Gnt-model-CalendarDay-method-getDate'>        /**
</span>         * @method getDate
         *
         * Returns the value of the `Date` field
         *
         * @return {Date} The date of this calendar day
         */
        {
            name        : 'Date',
            type        : 'date',
            dateFormat  : 'c',
            persist     : true,
            convert     : function (value, record) {
                if (!value) return;

                var converted   = Ext.data.Types.DATE.convert.call(this, value);

                if (converted) {
                    Ext.Date.clearTime(converted);
                }

                return converted;
            }
        },
<span id='Gnt-model-CalendarDay-method-getWeekday'>        /**
</span>         * @method getWeekday
         *
         * Returns the value of the `Weekday` field
         *
         * @return {Number} The index of the week day (0 - Sunday, 1 - Monday, etc).
         */
<span id='Gnt-model-CalendarDay-method-setWeekday'>        /**
</span>         * @method setWeekday
         *
         * Sets value of the `Weekday` field
         *
         * @param {Number} weekday The index of the week day (0 - Sunday, 1 - Monday, etc).
         */
        {
            name            : 'Weekday',
            type            : 'int'
        },
<span id='Gnt-model-CalendarDay-method-getOverrideStartDate'>        /**
</span>         * @method getOverrideStartDate
         *
         * Returns the start date of the timespan for the week day override.
         *
         * @return {Date} The start date
         */
<span id='Gnt-model-CalendarDay-method-setOverrideStartDate'>        /**
</span>         * @method setOverrideStartDate
         *
         * Sets the start date of the timespan for the week day override
         *
         * @param {Date} startDate The new start date
         */
        {
            name            : 'OverrideStartDate',
            type            : 'date',
            dateFormat      : 'c'
        },
<span id='Gnt-model-CalendarDay-method-getOverrideEndDate'>        /**
</span>         * @method getOverrideEndDate
         *
         * Returns the end date of the timespan for the week day override.
         *
         * @return {Date} The end date
         */
<span id='Gnt-model-CalendarDay-method-setOverrideEndDate'>        /**
</span>         * @method setOverrideEndDate
         *
         * Sets the end date of the timespan for the week day override
         *
         * @param {Date} endDate The new end date
         */
        {
            name            : 'OverrideEndDate',
            type            : 'date',
            dateFormat      : 'c'
        },
        {
            name            : 'Type',
            defaultValue    : 'DAY' // 'DAY', 'WEEKDAY', 'WEEKDAYOVERRIDE'
        },
        { name: 'IsWorkingDay', type: 'boolean', defaultValue : false },

<span id='Gnt-model-CalendarDay-method-getCls'>        /**
</span>         * @method getCls
         *
         * Gets the &quot;class&quot; of the day
         *
         * @return {String} cls The &quot;class&quot; of the day
         */
<span id='Gnt-model-CalendarDay-method-setCls'>        /**
</span>         * @method setCls
         *
         * Sets the &quot;class&quot; of the day
         *
         * @param {String} cls The new class of the day
         */
        {
            name            : 'Cls',
            defaultValue    : 'gnt-holiday'
        },

<span id='Gnt-model-CalendarDay-method-getName'>        /**
</span>         * @method getName
         *
         * Gets the &quot;name&quot; of the day
         *
         * @return {String} name The &quot;name&quot; of the day
         */
<span id='Gnt-model-CalendarDay-method-setName'>        /**
</span>         * @method setName
         *
         * Sets the &quot;name&quot; of the day
         *
         * @param {String} name The new name of the day
         */
        'Name',

        // [ '08:00-12:00', '13:00-17:00' ]
        {
            name        : 'Availability',
            persist     : true,
            convert     : function (value, record) {
                if (value) {
                    return Ext.typeOf(value) === 'string' ? [ value ] : value;
                } else {
                    return [];
                }
            }
        }
    ],

<span id='Gnt-model-CalendarDay-property-availabilityCache'>    availabilityCache           : null,
</span>
<span id='Gnt-model-CalendarDay-cfg-weekDayField'>    /**
</span>     * @cfg {String} weekDayField The name of the `Weekday` field.
     */
    weekDayField                : 'Weekday',

<span id='Gnt-model-CalendarDay-cfg-overrideStartDateField'>    /**
</span>     * @cfg {String} overrideStartDateField The name of the `OverrideStartDate` field.
     */
    overrideStartDateField      : 'OverrideStartDate',

<span id='Gnt-model-CalendarDay-cfg-overrideEndDateField'>    /**
</span>     * @cfg {String} overrideEndDateField The name of the `OverrideEndDate` field.
     */
    overrideEndDateField        : 'OverrideEndDate',

<span id='Gnt-model-CalendarDay-cfg-typeField'>    /**
</span>     * @cfg {String} typeField The name of the `Type` field.
     */
    typeField                   : 'Type',

<span id='Gnt-model-CalendarDay-cfg-dateField'>    /**
</span>     * @cfg {String} dateField The name of the `Date` field.
     */
    dateField                   : 'Date',

<span id='Gnt-model-CalendarDay-cfg-isWorkingDayField'>    /**
</span>     * @cfg {String} isWorkingDayField The name of the `IsWorkingDay` field.
     */
    isWorkingDayField           : 'IsWorkingDay',

<span id='Gnt-model-CalendarDay-cfg-clsField'>    /**
</span>     * @cfg {String} clsField The name of the `Cls` field.
     */
    clsField                    : 'Cls',


<span id='Gnt-model-CalendarDay-cfg-nameField'>    /**
</span>     * @cfg {String} nameField The name of the `Name` field.
     */
    nameField                   : 'Name',

<span id='Gnt-model-CalendarDay-cfg-availabilityField'>    /**
</span>     * @cfg {String} availabilityField The name of the `Availability` field.
     */
    availabilityField           : 'Availability',


<span id='Gnt-model-CalendarDay-method-setDate'>    /**
</span>     * Sets the date for this day (will clear the time part)
     * @param {Date} date
     */
    setDate : function (date) {
        if (date) date      = Ext.Date.clearTime(date, true);

        this.set(this.dateField, date);
    },

<span id='Gnt-model-CalendarDay-method-clearDate'>    /**
</span>     * Clears the date for this day
     * @param {Date} date
     */
    clearDate : function () {
        this.set(this.dateField, null);
    },

<span id='Gnt-model-CalendarDay-method-getAvailability'>    /**
</span>     * This method returns the availability for this day. By default it will decode an array of strings '08:00-12:00' to an
     * array of objects like:
     *
            {
                startTime       : new Date(0, 0, 0, 8),
                endTime         : new Date(0, 0, 0, 12)
            }

     * You can pass the &quot;asString&quot; flag to disable that and just return strings.
     *
     * @param {Boolean} asString Whether to just return an array of strings, instead of objects.
     * @return {Object[]/String[]} Array of objects with &quot;startTime&quot;, &quot;endTime&quot; properties.
     */
    getAvailability : function (asString) {
        var me      = this;

        if (asString) {
            // Return the raw availability array with strings
            return this.get(this.availabilityField);
        }

        if (this.availabilityCache) {
            return this.availabilityCache;
        }

        var parsed  = [];

        Ext.Array.each(this.get(this.availabilityField), function (value) {
            parsed.push(Ext.typeOf(value) === 'string' ? me.parseInterval(value) : value);
        });

        this.verifyAvailability(parsed);

        return this.availabilityCache = parsed;
    },


<span id='Gnt-model-CalendarDay-method-setAvailability'>    /**
</span>     * This method updates the availability information for this day. It accept an array of strings: '08:00-12:00', or
     * objects like:

            {
                startTime       : new Date(0, 0, 0, 8),
                endTime         : new Date(0, 0, 0, 12)
            }

     * @param {Object[]/String[]} intervals Array of availability intervals
     */
    setAvailability : function (intervals) {
        // clear cache
        this.availabilityCache = null;

        this.set(this.availabilityField, this.stringifyIntervals(intervals));

        // to trigger the `verifyAvailability`
        this.getAvailability();
    },


<span id='Gnt-model-CalendarDay-method-verifyAvailability'>    verifyAvailability : function (intervals) {
</span>        intervals.sort(function (a, b) {
            return a.startTime - b.startTime;
        });

        Ext.Array.each(intervals, function (interval) {
            if (interval.startTime &gt; interval.endTime) {
                throw new Error(&quot;Start time &quot; + Ext.Date.format(interval.startTime, 'H:i') + &quot; is greater than end time &quot; + Ext.Date.format(interval.endTime, 'H:i'));
            }
        });

        for (var i = 1; i &lt; intervals.length; i++) {
            var prev        = intervals[ i - 1 ];
            var curr        = intervals[ i ];

            if (prev.endTime &gt; curr.startTime) {
                throw new Error(&quot;Availability intervals should not intersect: [&quot; + this.stringifyInterval(prev) + &quot;] and [&quot; + this.stringifyInterval(curr) + &quot;]&quot;);
            }
        }
    },


<span id='Gnt-model-CalendarDay-method-prependZero'>    prependZero : function (value) {
</span>        return value &lt; 10 ? '0' + value : value;
    },


<span id='Gnt-model-CalendarDay-method-stringifyInterval'>    stringifyInterval : function (interval) {
</span>        var startTime   = interval.startTime;
        var endTime     = interval.endTime;

        return this.prependZero(startTime.getHours()) + ':' + this.prependZero(startTime.getMinutes()) + '-' +
            (endTime.getDate() == 1 ? 24 : this.prependZero(endTime.getHours())) + ':' + this.prependZero(endTime.getMinutes());
    },


<span id='Gnt-model-CalendarDay-method-stringifyIntervals'>    stringifyIntervals : function (intervals) {
</span>        var me                  = this;
        var result              = [];

        Ext.Array.each(intervals, function (interval) {
            if (Ext.typeOf(interval) === 'string') {
                result.push(interval);
            } else {
                result.push(me.stringifyInterval(interval));
            }
        });

        return result;
    },


<span id='Gnt-model-CalendarDay-method-parseInterval'>    parseInterval : function (string) {
</span>        var match   = /(\d\d):(\d\d)-(\d\d):(\d\d)/.exec(string);

        if (!match) throw &quot;Invalid format for availability string: &quot; + string + &quot;. It should have exact format: hh:mm-hh:mm&quot;;

        return {
            startTime       : new Date(0, 0, 0, match[ 1 ], match[ 2 ]),
            endTime         : new Date(0, 0, 0, match[ 3 ], match[ 4 ])
        };
    },


<span id='Gnt-model-CalendarDay-method-getTotalHours'>    /**
</span>     * Returns the total length of all availability intervals for this day in hours.
     *
     * @return {Number}
     */
    getTotalHours : function () {
        return this.getTotalMS() / 1000 / 60 / 60;
    },


<span id='Gnt-model-CalendarDay-method-getTotalMS'>    /**
</span>     * Returns the total length of all availability intervals for this day in milliseconds.
     *
     * @return {Number}
     */
    getTotalMS : function () {
        var totalMS      = 0;

        Ext.Array.each(this.getAvailability(), function (interval) {
            totalMS      += interval.endTime - interval.startTime;
        });

        return totalMS;
    },


<span id='Gnt-model-CalendarDay-method-addAvailabilityInterval'>    /**
</span>     * Adds a new availability interval to this day. Both arguments should have the same format.
     *
     * @param {Date/String} startTime Start time of the interval. Can be a Date object (new Date(0, 0, 0, 8)) or just a plain string: '08'
     * @param {Date/String} endTime End time of the interval. Can be a Date object (new Date(0, 0, 0, 12)) or just a plain string: '12'
     */
    addAvailabilityInterval : function (startTime, endTime) {
        var interval;

        if (startTime instanceof Date) {
            interval        = {
                startTime       : startTime,
                endTime         : endTime
            };
        } else {
            interval        = this.parseInterval(startTime + (endTime ? '-' + endTime : ''));
        }

        var intervals       = this.getAvailability().concat(interval);

        this.verifyAvailability(intervals);

        this.setAvailability(intervals);
    },


<span id='Gnt-model-CalendarDay-method-removeAvailbilityInterval'>    /**
</span>     * Removes the availability interval by its index.
     *
     * @param {Number} index Ordinal position of the interval to be removed
     */
    removeAvailbilityInterval : function (index) {
        var intervals       = this.getAvailability();

        intervals.splice(index, 1);

        this.setAvailability(intervals);
    },


<span id='Gnt-model-CalendarDay-method-getAvailabilityIntervalsFor'>    /**
</span>     * Applies the availability intervals to a concrete day. For example the availability intervals [ '08:00-12:00', '13:00-17:00' ],
     * applied to a day 2012/01/01 will return the following result:
     *
    [
        {
            startDate       : new Date(2012, 0, 1, 8),
            endDate         : new Date(2012, 0, 1, 12)
        },
        {
            startDate       : new Date(2012, 0, 1, 13),
            endDate         : new Date(2012, 0, 1, 17)
        }
    ]

     *
     * @param {Date} date The date to apply the intervals to
     *
     * @returns {Object[]} Array of objects with &quot;startDate / endDate&quot; properties.
     */
    getAvailabilityIntervalsFor : function (timeDate) {
        timeDate                = typeof timeDate == 'number' ? new Date(timeDate) : timeDate;

        var year                = timeDate.getFullYear();
        var month               = timeDate.getMonth();
        var date                = timeDate.getDate();

        var result              = [];

        Ext.Array.each(this.getAvailability(), function (interval) {

            var endDate     = interval.endTime.getDate();

            result.push({
                startDate       : new Date(year, month, date, interval.startTime.getHours(), interval.startTime.getMinutes()),
                endDate         : new Date(year, month, date + (endDate == 1 ? 1 : 0), interval.endTime.getHours(), interval.endTime.getMinutes())
            });
        });

        return result;
    },


<span id='Gnt-model-CalendarDay-method-getAvailabilityStartFor'>    /**
</span>     * Returns the earliest available time for the given date. If this day has no availability intervals it returns `null`.
     *
     * @param {Date} date The date to get the earliest availability time for.
     *
     * @return {Date}
     */
    getAvailabilityStartFor : function (timeDate) {
        var intervals           = this.getAvailabilityIntervalsFor(timeDate);

        if (!intervals.length) {
            return null;
        }

        return intervals[ 0 ].startDate;
    },


<span id='Gnt-model-CalendarDay-method-getAvailabilityEndFor'>    /**
</span>     * Returns the latest available time for the given date. If this day has no availability intervals, it returns `null`.
     *
     * @param {Date} date The date to get the latest availability time for.
     *
     * @return {Date}
     */
    getAvailabilityEndFor : function (timeDate) {
        var intervals           = this.getAvailabilityIntervalsFor(timeDate);

        if (!intervals.length) {
            return null;
        }

        return intervals[ intervals.length - 1 ].endDate;
    }

});
</pre>
</body>
</html>
