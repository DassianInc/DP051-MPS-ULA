<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * This class manages model persistency, it listens to model stores' beforesync event and removes all non persistable
 * records from sync operation. The logic has meaning only for CRUD-less sync operations.
 *
 * @private
 */
if (!Ext.ClassManager.get(&quot;Sch.data.util.ModelPersistencyManager&quot;)) Ext.define('Sch.data.util.ModelPersistencyManager', {

    config : {
        eventStore      : null,
        resourceStore   : null,
        assignmentStore : null
    },

    eventStoreDetacher      : null,
    resourceStoreDetacher   : null,
    assignmentStoreDetacher : null,

    constructor : function(config) {
        this.initConfig(config);
    },

    // {{{ Event attachers
    updateEventStore : function(newEventStore, oldEventStore) {
        var me = this;

        Ext.destroyMembers(me, 'eventStoreDetacher');

        if (newEventStore &amp;&amp; newEventStore.autoSync) {
            me.eventStoreDetacher = newEventStore.on({
                beforesync  : me.onEventStoreBeforeSync,
                scope       : me,
                destroyable : true,
                // Just in case
                priority    : 100
            });
        }
    },

    updateResourceStore : function(newResourceStore, oldResourceStore) {
        var me = this;

        Ext.destroyMembers(me, 'resourceStoreDetacher');

        if (newResourceStore &amp;&amp; newResourceStore.autoSync) {
            me.resourceStoreDetacher = newResourceStore.on({
                beforesync  : me.onResourceStoreBeforeSync,
                scope       : me,
                destroyable : true,
                // Just in case
                priority    : 100
            });
        }
    },

    updateAssignmentStore : function(newAssignmentStore, oldAssignmentStore) {
        var me = this;

        Ext.destroyMembers(me, 'assignmentStoreDetacher');

        if (newAssignmentStore &amp;&amp; newAssignmentStore.autoSync) {
            me.assignmentStoreDetacher = newAssignmentStore.on({
                beforesync  : me.onAssignmentStoreBeforeSync,
                scope       : me,
                destroyable : true,
                // Just in case
                priority    : 100
            });
        }
    },
    // }}}

    // {{{ Event handlers
    onEventStoreBeforeSync : function(options) {
        var me = this;
        me.removeNonPersistableRecordsToCreate(options);
        return me.shallContinueSync(options);
    },

    onResourceStoreBeforeSync : function(options) {
        var me = this;
        me.removeNonPersistableRecordsToCreate(options);
        return me.shallContinueSync(options);
    },

    onAssignmentStoreBeforeSync : function(options) {
        var me = this;
        me.removeNonPersistableRecordsToCreate(options);
        return me.shallContinueSync(options);
    },
    // }}}

    // {{{ Management rules
    removeNonPersistableRecordsToCreate : function(options) {
        var recordsToCreate = options.create || [],
            r, i;

        // We remove from the array we iterate thus we iterate from end to start
        for (i = recordsToCreate.length - 1; i &gt;= 0; --i) {
            r = recordsToCreate[i];
            if (!r.isPersistable()) {
                Ext.Array.remove(recordsToCreate, r);
            }
        }

        // Prevent empty create request
        if (recordsToCreate.length === 0) {
            delete options.create;
        }
    },

    shallContinueSync : function(options) {
        return Boolean((options.create  &amp;&amp; options.create.length  &gt; 0) ||
                       (options.update  &amp;&amp; options.update.length  &gt; 0) ||
                       (options.destroy &amp;&amp; options.destroy.length &gt; 0));
    }
    // }}}
});
</pre>
</body>
</html>
