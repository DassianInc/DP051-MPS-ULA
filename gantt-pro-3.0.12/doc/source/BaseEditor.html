<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Gnt-plugin-taskeditor-BaseEditor'>/**
</span>@class Gnt.plugin.taskeditor.BaseEditor
*/
Ext.define('Gnt.plugin.taskeditor.BaseEditor', {
    extend                      : 'Ext.window.Window',

    requires                    : ['Ext.window.MessageBox'],
    mixins                      : ['Ext.AbstractPlugin', 'Gnt.mixin.Localizable'],

<span id='Gnt-plugin-taskeditor-BaseEditor-property-lockableScope'>    lockableScope               : 'top',
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-taskEditorCls'>    /**
</span>    * @cfg {Object} taskEditorCls Class for the {@link Gnt.widget.taskeditor.TaskEditor} instance.
    */
    taskEditorCls               : 'Gnt.widget.taskeditor.TaskEditor',

<span id='Gnt-plugin-taskeditor-BaseEditor-property-isTaskEditor'>    /**
</span>     * @property {Boolean} isTaskEditor
     * @readonly
     * Indicates that the class extends {@link Gnt.plugin.taskeditor.BaseEditor} class.
     */
    isTaskEditor                : true,

<span id='Gnt-plugin-taskeditor-BaseEditor-property-taskEditor'>    /**
</span>     * @property {Gnt.widget.taskeditor.BaseEditor} taskEditor The task editor widget contained by the plugin.
     */
    taskEditor                  : null,

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-panelConfig'>    /**
</span>     * @cfg {Object} panelConfig Configuration for {@link Gnt.widget.taskeditor.BaseEditor} instance.
     */
    panelConfig                 : null,

<span id='Gnt-plugin-taskeditor-BaseEditor-property-height'>    height                      : 340,
</span><span id='Gnt-plugin-taskeditor-BaseEditor-property-width'>    width                       : 600,
</span><span id='Gnt-plugin-taskeditor-BaseEditor-property-layout'>    layout                      : 'card',
</span><span id='Gnt-plugin-taskeditor-BaseEditor-property-constrain'>    constrain                   : true,
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-triggerEvent'>    /**
</span>     * @cfg {String} triggerEvent
     * The event upon which the editor shall be shown. Defaults to 'taskdblclick'.
     */
    triggerEvent                : 'taskdblclick',

<span id='Gnt-plugin-taskeditor-BaseEditor-property-closeAction'>    closeAction                 : 'hide',
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-property-modal'>    modal                       : true,
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-property-gantt'>    gantt                       : null,
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-assignmentStore'>    /**
</span>     * @cfg {Gnt.data.AssignmentStore} assignmentStore A store with assignments.
     * If this config is not provided plugin will try to retrieve assignments store from {@link Gnt.panel.Gantt} instance.
     */
    assignmentStore             : null,

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-resourceStore'>    /**
</span>     * @cfg {Gnt.data.ResourceStore} resourceStore A store with resources.
     * If this config is not provided plugin will try to retrieve resources store from {@link Gnt.panel.Gantt} instance.
     */
    resourceStore               : null,

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-taskStore'>    /**
</span>     * @cfg {Gnt.data.TaskStore} taskStore A store with tasks.
     * If this config is not provided plugin will try to retrieve tasks store from {@link Gnt.panel.Gantt} instance.
     * **Note:** Task store is required if task doesn't belong to any task store yet.
     */
    taskStore                   : null,

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-task'>    /**
</span>     * @cfg {Gnt.model.Task} task The task to show in the task editor.
     */

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-l10n'>    /**
</span>     * @cfg {Object} l10n
     * A object, purposed for the class localization. Contains the following keys/values:

            - title               : 'Task Information',
            - alertCaption        : 'Information',
            - alertText           : 'Please correct marked errors to save changes',
            - okText              : 'Ok',
            - cancelText          : 'Cancel',
     */

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-monitorDataUpdates'>    /**
</span>     * @cfg {Boolean} [monitorDataUpdates=false]
     *
     * Whether to actively monitor data updates or not, if set to true then Ok button (if present) will be enabled
     * only if there're data changes introduced in the Task Editor and those changes are valid.
     */
    monitorDataUpdates          : false,

<span id='Gnt-plugin-taskeditor-BaseEditor-cfg-monitorDataUpdatesInterval'>    /**
</span>     * @cfg {Integer} monitorDataUpdatesInterval
     *
     * Timeout to use to monitor data updates.
     */
    monitorDataUpdatesInterval  : 500,

<span id='Gnt-plugin-taskeditor-BaseEditor-property-taskEditorConfigs'>    taskEditorConfigs           : 'l10n,task,taskStore,assignmentStore,resourceStore',
</span>
<span id='Gnt-plugin-taskeditor-BaseEditor-property-taskFilters'>    taskFilters                 : null,
</span>

<span id='Gnt-plugin-taskeditor-BaseEditor-method-constructor'>    constructor : function (config) {
</span>        config              = config || {};

        this.taskFilters    = [];

        // we need to apply config to let locale()
        // know about legacy locales since it will check them in 'this'
        Ext.apply(this, config);

        this.title          = this.L('title');

        // by default we make 'Ok', 'Cancel' buttons
        if (!config.buttons) {
            this.buttons    = ['-&gt;',
                {
                    itemId  : 'teOkBtn',
                    text    : this.L('okText'),
                    handler : function() {
                        this.completeEditing() || Ext.Msg.alert(this.L('alertCaption'), this.L('alertText'));
                    },
                    scope   : this
                },
                {
                    text    : this.L('cancelText'),
                    handler : this.close,
                    scope   : this
                }
            ];
        }

        this.callParent([config]);
        this.addCls('gnt-taskeditor-window');
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-getState'>    getState : function () {
</span>        if (this.rendered) {
            return this.callParent(arguments);
        }
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-init'>    init : function (cmp) {
</span>        // if assignmentStore or resourceStore wasn't defined as configuration options
        // during plugin constructing we get them from Gnt.panel.Gantt instance
        this.assignmentStore    = this.assignmentStore || cmp.getAssignmentStore();
        this.resourceStore      = this.resourceStore || cmp.getResourceStore();
        this.taskStore          = this.taskStore || cmp.getTaskStore();

        // let's map some configuration options from plugin to taskEditor
        var cfg     = {
            width   : null,
            height  : null,
            border  : false
        };

        // some confis are mapped from this instance to task editor widget
        Ext.copyTo(cfg, this, this.taskEditorConfigs);

        cfg.showBaseline    = cmp.enableBaseline;

        cfg.showRollup      = cmp.showRollupTasks;

        cfg.allowParentTaskDependencies = cmp.allowParentTaskDependencies;

        this.buildTaskEditor(Ext.apply(cfg, this.panelConfig));

        this.add(this.taskEditor);

        this.mon(cmp, this.triggerEvent, this.onTriggerEvent, this);

        this.gantt          = cmp;
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-buildTaskEditor'>    /**
</span>     * @protected
     * Builds the task editor widget instance being used by the plugin.
     * By default this method creates {@link Gnt.widget.taskeditor.TaskEditor} instance and puts a reference to the instance to {@link #taskEditor} property.
     * Override this if you want to instantiate your custom class instead.
     * @param  {Object} cfg Configuration of the task editor widget being instantiated
     */
    buildTaskEditor : function (cfg) {
        this.taskEditor = Ext.create(this.taskEditorCls, cfg);
        this.relayEvents(this.taskEditor, ['loadtask', 'validate', 'beforeupdatetask', 'afterupdatetask']);
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-onTriggerEvent'>    onTriggerEvent : function (gantt, task) {
</span>        this.showTask(task);
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-showTask'>    /**
</span>     * Shows window and loads task into the task editor.
     * @param {Gnt.model.Task} task Task to load.
     */
    showTask : function (task) {
        if (this.taskEditor &amp;&amp; task &amp;&amp; this.matchFilters(task)) {
            this.taskEditor.loadTask(task);
            this.show();
        }
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-matchFilters'>    matchFilters : function (task) {
</span>        if (!task) return;

        for (var i = 0; i &lt; this.taskFilters.length; i++) {
            var filter  = this.taskFilters[i];
            if (!filter.fn.call(filter.scope, task)) return false;
        }

        return true;
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-addFilter'>    addFilter : function (fn, scope) {
</span>        this.taskFilters.push({
            fn      : fn,
            scope   : scope || this
        });
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-validate'>    validate : function () {
</span>        if (this.taskEditor) {
            return this.taskEditor.validate();
        }
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-completeEditing'>    /**
</span>     * This function is a shorthand for the following typical steps:
     *
     *      if (!taskEditor.validate()) {
     *          Ext.MessageBox.alert('Information', 'Please correct marked errors to save changes');
     *      } else {
     *          if (taskEditor.updateTask()) taskEditor.hide();
     *      }
     *
     * Instead of above code you can write:
     *
     *      if (!taskEditor.completeEditing()) {
     *          Ext.MessageBox.alert('Information', 'Please correct marked errors to save changes');
     *      }
     *
     * @return {Boolean} true if validation successfully passed and record was successfully updated as well.
     */
    completeEditing : function () {

        if (this.taskEditor) {
            var activeTab = this.taskEditor.getActiveTab();

            // Force any active editing to complete first
            if (activeTab.editingPlugin &amp;&amp; activeTab.editingPlugin.completeEdit) {
                activeTab.editingPlugin.completeEdit();
            }

            if (!this.taskEditor.validate()) return false;

            if (this.taskEditor.updateTask()) {
                this.hide();
                return true;
            }

            return false;
        }
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-updateTask'>    /**
</span>     * Persists the values in this task editor into corresponding {@link Gnt.model.Task}
     * object provided to {@link #showTask}.
     * Internally just calls {@link Gnt.widget.taskeditor.TaskEditor#updateTask updateTask} method of task editor panel.
     */
    updateTask : function () {
        if (this.taskEditor) {
            return this.taskEditor.updateTask();
        }
    },


<span id='Gnt-plugin-taskeditor-BaseEditor-method-afterRender'>    afterRender : function() {
</span>        var me = this;
        me.callParent(arguments);
        me.startDataUpdatesMonitoring();
    },

<span id='Gnt-plugin-taskeditor-BaseEditor-method-startDataUpdatesMonitoring'>    startDataUpdatesMonitoring : function() {
</span>        var me = this,
            okBtn = me.down('#teOkBtn'),
            timerId = true;

        function monitor() {
            if (timerId &amp;&amp; okBtn &amp;&amp; me.taskEditor) {
                okBtn.setDisabled(!me.taskEditor.isDataChanged() || !me.taskEditor.isDataValid());
                timerId = Ext.Function.defer(monitor, me.monitorDataUpdatesInterval);
            }
        }

        function unmonitor() {
            timerId !== true &amp;&amp; clearTimeout(timerId);
            timerId = true;
        }

        if (me.monitorDataUpdates &amp;&amp; okBtn) {
            me.on({
                'show'    : monitor,
                'hide'    : unmonitor,
                'destroy' : unmonitor
            });
        }
    }
});
</pre>
</body>
</html>
